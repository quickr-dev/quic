#!/bin/bash

if [ $# -eq 0 ]; then
    echo "Usage: $0 <test_file_or_test_name>"
    echo "Examples:"
    echo "  $0 e2e/cli/user_create_test.go"
    echo "  $0 TestQuicUserCreate/successful_user_creation"
    echo "  DEBUG=1 $0 TestQuicHostSetup  # Enable debug output"
    exit 1
fi

go build -o bin/quic ./cmd/quic
go build -o bin/quicd ./cmd/quicd

if test -f "$1"; then
    # Run all tests from the specified file by running the package and extracting test names
    test_functions=$(grep -o 'func Test[A-Za-z0-9_]*' "$1" | sed 's/func //' | tr '\n' '|' | sed 's/|$//')
    if [ -n "$test_functions" ]; then
        env go test ./e2e/cli -v -count=1 -run "^($test_functions)$"
    else
        echo "No test functions found in $1"
        exit 1
    fi
else
    env go test ./e2e/cli -v -count=1 -run "$1"
fi
